# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           active_variants 1.1
PortGroup           cmake 1.0
PortGroup           cxx11 1.0

github.setup        darktable-org darktable 2.2.3 release-
revision            1
github.tarball_from releases
use_xz              yes

# remove after next release:
dist_subdir   ${name}/${version}_1

checksums           rmd160  7c1a2297df602e10bfc914af060ad139ada06d90 \
                    sha256  1b33859585bf283577680c61e3c0ea4e48214371453b9c17a86664d2fbda48a0

set branch          [join [lrange [split ${version} .] 0 1] .]
categories          graphics
platforms           darwin
supported_archs     x86_64
maintainers         nomaintainer
license             GPL-3+

description         Virtual lighttable and darkroom for photographers

long_description    Darktable is a virtual lighttable and darkroom for \
                    photographers: it manages your digital negatives in a \
                    database and lets you view them through a zoomable \
                    lighttable. It also enables you to develop raw images \
                    and enhance them.

homepage            http://www.darktable.org/

depends_build-append  port:pkgconfig

depends_lib-append  port:atk \
                    path:lib/pkgconfig/cairo.pc:cairo \
                    port:curl \
                    port:exiv2 \
                    port:flickcurl \
                    port:GraphicsMagick \
                    port:gdk-pixbuf2 \
                    port:gettext \
                    port:glib2 \
                    port:gtk-osx-application-gtk3 \
                    port:gtk3 \
                    port:ilmbase \
                    port:jpeg \
                    port:json-glib \
                    port:lcms2 \
                    port:lensfun \
                    port:libgphoto2 \
                    port:libpng \
                    port:librsvg \
                    port:libsecret \
                    port:libsoup \
                    port:libusb \
                    port:lua52 \
                    port:libxml2 \
                    port:openexr \
                    port:openjpeg \
                    port:osm-gps-map \
                    port:pango \
                    port:pugixml \
                    port:sqlite3 \
                    port:webp \
                    port:tiff \
                    port:zlib

depends_run         port:adwaita-icon-theme

require_active_variants gtk3 quartz

cmake.out_of_source yes

configure.args-append \
                    -DBUILD_CMSTEST=OFF \
                    -DTESTBUILD_OPENCL_PROGRAMS=OFF \
                    -DUSE_COLORD=OFF \
                    -DUSE_KWALLET=OFF \
                    -DUSE_OPENMP=OFF \
                    -DUSE_UNITY=OFF

post-destroot {
    # need to determine why lib is not going where expected, until then...
    move ${destroot}${prefix}/lib/darktable/libdarktable.dylib ${destroot}${prefix}/lib/
}

universal_variant   no

# With gcc5 or gcc6, tries to build src/osx/osx.mm with gcc which results
# in a cascade of errors.  Leave disabled until a solution is found
# variant gcc5 description {Build with gcc5 to enable OpenMP for speed} {
#     depends_lib-append      port:gcc5
#     configure.args-replace  -DUSE_OPENMP=OFF -DUSE_OPENMP=ON
#     configure.compiler      macports-gcc-5
# }

variant clang39 description {Build with clang 3.9 to enable OpenMP for speed} {
    depends_lib-append      port:clang-3.9
    configure.args-replace  -DUSE_OPENMP=OFF -DUSE_OPENMP=ON
    configure.compiler      macports-clang-3.9
}

default_variants    +clang39


notes "
Online documentation for ${name} is at:
http://www.darktable.org/usermanual/index.html.php

PDF documentation may be downloaded at:
http://www.darktable.org/resources/
"
livecheck.url       https://github.com/darktable-org/darktable/releases
livecheck.regex     release-(${branch}.\[0-9.\]?).tar
